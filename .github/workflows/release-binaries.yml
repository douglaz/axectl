name: Release Binaries

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:  # Allow manual trigger

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: write  # Required for creating releases

jobs:
  build-linux:
    name: Build Linux Binaries
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v5
    
    - name: Install Nix
      uses: cachix/install-nix-action@v31
      with:
        extra_nix_config: |
          experimental-features = nix-command flakes
    
    - name: Cache Cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
        key: cargo-registry-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          cargo-registry-${{ runner.os }}-
    
    - name: Build x86_64 Linux
      run: |
        nix develop -c cargo build --release
        mkdir -p artifacts/linux-x86_64
        cp target/x86_64-unknown-linux-musl/release/axectl artifacts/linux-x86_64/axectl
        chmod +x artifacts/linux-x86_64/axectl
    
    - name: Create checksums
      run: |
        cd artifacts
        for dir in */; do
          (cd "$dir" && sha256sum axectl > axectl.sha256)
        done
    
    - name: Create tarball archives
      run: |
        cd artifacts
        for dir in */; do
          dirname="${dir%/}"
          tar czf "axectl-${dirname}.tar.gz" "$dirname"
        done
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: axectl-linux-binaries
        path: artifacts/*.tar.gz
        retention-days: 90

  build-macos:
    name: Build macOS Binaries
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v5
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: x86_64-apple-darwin,aarch64-apple-darwin
    
    - name: Cache Cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
        key: cargo-registry-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          cargo-registry-${{ runner.os }}-
    
    - name: Build x86_64 macOS
      run: |
        cargo build --release --target x86_64-apple-darwin
        mkdir -p artifacts/macos-x86_64
        cp target/x86_64-apple-darwin/release/axectl artifacts/macos-x86_64/axectl
        chmod +x artifacts/macos-x86_64/axectl
    
    - name: Build ARM64 macOS (Apple Silicon)
      run: |
        cargo build --release --target aarch64-apple-darwin
        mkdir -p artifacts/macos-aarch64
        cp target/aarch64-apple-darwin/release/axectl artifacts/macos-aarch64/axectl
        chmod +x artifacts/macos-aarch64/axectl
    
    - name: Create checksums
      run: |
        cd artifacts
        for dir in */; do
          (cd "$dir" && shasum -a 256 axectl > axectl.sha256)
        done
    
    - name: Create tarball archives
      run: |
        cd artifacts
        for dir in */; do
          dirname="${dir%/}"
          tar czf "axectl-${dirname}.tar.gz" "$dirname"
        done
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: axectl-macos-binaries
        path: artifacts/*.tar.gz
        retention-days: 90

  build-windows:
    name: Build Windows Binaries
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v5
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: x86_64-pc-windows-msvc
    
    - name: Cache Cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
        key: cargo-registry-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          cargo-registry-${{ runner.os }}-
    
    - name: Build x86_64 Windows
      run: |
        cargo build --release --target x86_64-pc-windows-msvc
        New-Item -ItemType Directory -Force -Path artifacts/windows-x86_64
        Copy-Item target/x86_64-pc-windows-msvc/release/axectl.exe artifacts/windows-x86_64/axectl.exe
    
    - name: Create checksums
      shell: powershell
      run: |
        cd artifacts
        Get-ChildItem -Directory | ForEach-Object {
          cd $_.Name
          $hash = Get-FileHash -Algorithm SHA256 axectl.exe
          "$($hash.Hash.ToLower())  axectl.exe" | Out-File -Encoding ASCII axectl.sha256
          cd ..
        }
    
    - name: Create ZIP archives
      shell: powershell
      run: |
        cd artifacts
        Get-ChildItem -Directory | ForEach-Object {
          Compress-Archive -Path $_.FullName -DestinationPath "axectl-$($_.Name).zip"
        }
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: axectl-windows-binaries
        path: artifacts/*.zip
        retention-days: 90

  create-release:
    name: Create GitHub Release
    needs: [build-linux, build-macos, build-windows]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    
    steps:
    - uses: actions/checkout@v5
    
    - name: Download all artifacts
      uses: actions/download-artifact@v5
      with:
        path: release-artifacts
    
    - name: Get short SHA
      id: sha
      run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
    
    - name: Get date
      id: date
      run: echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT
    
    - name: Prepare release files
      run: |
        mkdir -p release-files
        mv release-artifacts/axectl-linux-binaries/* release-files/
        mv release-artifacts/axectl-macos-binaries/* release-files/
        mv release-artifacts/axectl-windows-binaries/* release-files/
        
        # Add the bootstrap script
        cp axectl.sh release-files/
        chmod +x release-files/axectl.sh
        
        ls -la release-files/
    
    - name: Create release notes
      run: |
        cat > release-notes.md << EOF
        ## axectl Latest Build (master branch)
        
        **Build Date:** $(date +'%Y-%m-%d %H:%M:%S UTC')
        **Commit:** ${{ steps.sha.outputs.sha_short }}
        
        ### Available Binaries
        
        #### Linux
        - \`axectl-linux-x86_64.tar.gz\` - Static musl binary (works on all Linux distros)
        
        #### macOS
        - \`axectl-macos-x86_64.tar.gz\` - Intel Mac binary
        - \`axectl-macos-aarch64.tar.gz\` - Apple Silicon (M1/M2/M3) binary
        
        #### Windows
        - \`axectl-windows-x86_64.zip\` - Windows 64-bit executable
        
        ### Installation
        
        #### Quick Install (Using Bootstrap Script)
        
        Download and use \`axectl.sh\` for automatic installation and updates:
        
        \`\`\`bash
        curl -L https://github.com/douglaz/axectl/releases/download/latest-master/axectl.sh -o axectl.sh
        chmod +x axectl.sh
        ./axectl.sh --help
        \`\`\`
        
        The bootstrap script will:
        - Automatically detect your platform
        - Download the appropriate binary
        - Extract and install to \`~/.local/bin\`
        - Check for updates periodically
        - Use local builds when available (for development)
        
        #### Manual Installation
        
        1. Download the appropriate binary for your platform
        2. Extract the archive
        3. Make the binary executable (Linux/macOS): \`chmod +x axectl\`
        4. Optionally move to your PATH: \`sudo mv axectl /usr/local/bin/\`
        
        ### Verify Checksums
        
        Each archive contains a \`.sha256\` file with the binary's checksum.
        
        \`\`\`bash
        # Linux/macOS
        sha256sum -c axectl.sha256
        
        # Windows (PowerShell)
        Get-FileHash axectl.exe -Algorithm SHA256
        \`\`\`
        
        ### Features
        
        - **Auto-Discovery**: mDNS and network scanning for AxeOS devices
        - **Device Monitoring**: Real-time hashrate, temperature, and power metrics
        - **Device Control**: Fan speed, restart, and configuration management
        - **Multi-Device Support**: Bitaxe and NerdQAxe compatibility
        - **JSON Output**: Machine-readable format for automation
        
        ---
        *This is an automated build from the master branch. For stable releases, see the Releases page.*
        EOF
    
    - name: Delete existing latest release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Delete the release if it exists
        gh release delete latest-master --yes 2>/dev/null || true
        
        # Delete the tag if it exists
        git push --delete origin latest-master 2>/dev/null || true
    
    - name: Create new release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh release create latest-master \
          --title "Latest Build (master)" \
          --notes-file release-notes.md \
          --prerelease \
          release-files/*